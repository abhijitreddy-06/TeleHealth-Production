<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Video Dashboard | TeleHealth</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

<link href="/css/doc_video_dashboard.css" rel="stylesheet" />
</head>

<body>
    <!-- ================= HEADER & NAVIGATION ================= -->
    <header>
        <nav class="navbar">
            <a href="/doc_home" class="logo">
                <i class="fas fa-heartbeat"></i>
                <span class="logo-text">TeleHealth</span>
            </a>

            <div class="nav-links">
                <a href="/doc_home"><i class="fas fa-home"></i> Home</a>
                <a href="/doc_video_dashboard" class="active"><i class="fas fa-video"></i> Video</a>
                <a href="/doc_profile"><i class="fas fa-user-md"></i> Profile</a>

                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <div class="mobile-controls">
                <button class="theme-toggle" id="mobileThemeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- ================= MOBILE MENU ================= -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="close-menu" id="closeMenu">
            <i class="fas fa-times"></i>
        </button>
        <a href="/doc_home"><i class="fas fa-home"></i> Home</a>
        <a href="/doc_video_dashboard" class="active"><i class="fas fa-video"></i> Video</a>
        <a href="/doc_profile"><i class="fas fa-user-md"></i> Profile</a>
    </div>

    <!-- ================= MAIN CONTENT ================= -->
    <main>
        <div class="dashboard-header">
            <h1>Video Consultation Dashboard</h1>
            <p>Start and manage your virtual consultations with patients</p>
        </div>

        <div class="dashboard-grid">
            <!-- Appointment Details Card -->
            <div class="appointment-card">
                <div class="appointment-header">
                    <div class="appointment-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <h2>Upcoming Appointment</h2>
                </div>

                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">Patient:</span>
                        <span class="info-value" id="patientName">Loading...</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Date:</span>
                        <span class="info-value" id="apptDate">—</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Time:</span>
                        <span class="info-value" id="apptTime">—</span>
                    </div>
                </div>

                <div class="status-container">
                    <p id="statusText" class="status">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        Checking appointment status...
                    </p>
                    <button id="startBtn" class="btn btn-primary" disabled onclick="startCall()">
                        <i class="fas fa-video"></i>
                        Start Call
                    </button>
                </div>
            </div>

            <!-- Instructions Card -->
            <div class="instructions-card">
                <h3><i class="fas fa-info-circle"></i> Consultation Guidelines</h3>
                <div class="instructions-list">
                    <div class="instruction-item">
                        <div class="instruction-number">1</div>
                        <div class="instruction-content">
                            <h4>Prepare Consultation Room</h4>
                            <p>Ensure your environment is professional, quiet, and well-lit</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">2</div>
                        <div class="instruction-content">
                            <h4>Check Equipment</h4>
                            <p>Test your camera, microphone, and internet connection before starting</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">3</div>
                        <div class="instruction-content">
                            <h4>Review Patient Information</h4>
                            <p>Have the patient's medical history and notes ready</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">4</div>
                        <div class="instruction-content">
                            <h4>End Consultation Properly</h4>
                            <p>Summarize the consultation and provide follow-up instructions</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- ================= FOOTER ================= -->
    <footer class="simple-footer">
        <div class="footer-content">
            <div class="footer-left">
                <a href="/user_home" class="footer-logo">
                    <i class="fas fa-heartbeat"></i>
                    <span>TeleHealth</span>
                </a>
                <div class="copyright">
                    © 2025 TeleHealth. All rights reserved.
                </div>
            </div>
    
            <div class="footer-links">
                <a href="/privacy">Privacy Policy</a>
                <span class="separator">|</span>
                <a href="/terms">Terms of Service</a>
                <span class="separator">|</span>
                <a href="/contact">Contact</a>
            </div>
        </div>
    </footer>

    <!-- ================= CHATBOT ================= -->


<script src="/js/authGuard.js"></script>
<script>
    /* =========================
       STATE
    ========================= */
        let appointmentId = null;
        let polling = null;

        /* =========================
           LOAD APPOINTMENT
        ========================= */
        async function loadAppointment() {
            try {
                const res = await fetch("/api/appointments/doctor", {
                    credentials: "include"
                });

                const appointments = await res.json();

                const patientName = document.getElementById("patientName");
                const apptDate = document.getElementById("apptDate");
                const apptTime = document.getElementById("apptTime");
                const statusText = document.getElementById("statusText");
                const startBtn = document.getElementById("startBtn");
                const sendBtn = document.getElementById("sendPrescriptionBtn");

                if (!appointments.length) {
                    clearInterval(polling);

                    patientName.innerText = "—";
                    apptDate.innerText = "—";
                    apptTime.innerText = "—";

                    statusText.innerHTML = `<i class="fas fa-calendar-times"></i> No upcoming appointments`;
                    statusText.className = "status completed";

                    startBtn.disabled = true;
                    startBtn.innerHTML = `<i class="fas fa-calendar-times"></i> No Appointments`;
                    startBtn.className = "btn btn-completed";
                    return;
                }

                const appt = appointments[0];
                appointmentId = appt.id;

                patientName.innerText = appt.user_name || "Patient";
                apptDate.innerText = appt.appointment_date;
                apptTime.innerText = appt.appointment_time;

                // Scheduled
                if (appt.status === "scheduled") {
                    statusText.innerHTML = `<i class="fas fa-clock"></i> Ready to start`;
                    statusText.className = "status ready";

                    startBtn.disabled = false;
                    startBtn.innerHTML = `<i class="fas fa-video"></i> Start Call`;
                    startBtn.className = "btn btn-primary";
                    startBtn.onclick = startCall;
                }

                // Started
                if (appt.status === "started" && appt.room_id) {
                    statusText.innerHTML = `<i class="fas fa-video"></i> Call in progress`;
                    statusText.className = "status waiting";

                    startBtn.disabled = false;
                    startBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Join Call`;
                    startBtn.className = "btn btn-success";
                    startBtn.onclick = () => joinCall(appt.room_id);
                }

                // Completed
                if (appt.status === "completed") {
                    clearInterval(polling);

                    statusText.innerHTML = `<i class="fas fa-check-circle"></i> Appointment completed`;
                    statusText.className = "status completed";

                    startBtn.disabled = true;
                    startBtn.innerHTML = `<i class="fas fa-check-circle"></i> Completed`;
                    startBtn.className = "btn btn-completed";
                    startBtn.onclick = null;

                    if (sendBtn) sendBtn.style.display = "inline-flex";
                }

            } catch (err) {
                console.error(err);
                const statusText = document.getElementById("statusText");
                if (statusText) {
                    statusText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Failed to load appointment`;
                }
            }
        }

        /* =========================
           START CALL
        ========================= */
        async function startCall() {
            if (!appointmentId) return;

            try {
                const res = await fetch(`/appointments/${appointmentId}/start`, {
                    method: "POST",
                    credentials: "include"
                });

             const text = await res.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    throw new Error("Server returned invalid response");
                }


                if (!res.ok) {
                    alert(data.error || "Unable to start call");
                    return;
                }

                window.location.href = `/doc_video/${data.roomId}`;

            } catch (err) {
                console.error(err);
                alert("Server error while starting call");
            }
        }

        /* =========================
           JOIN CALL
        ========================= */
        function joinCall(roomId) {
            if (!roomId) return;
            window.location.href = `/doc_video/${roomId}`;
        }

        /* =========================
           THEME TOGGLE
        ========================= */
        const themeToggle = document.getElementById("themeToggle");
        const mobileThemeToggle = document.getElementById("mobileThemeToggle");
        const html = document.documentElement;

        const savedTheme =
            localStorage.getItem("theme") ||
            (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        html.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);

        function toggleTheme() {
            const next = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
            html.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = theme === "dark" ? "fa-sun" : "fa-moon";
            themeToggle && (themeToggle.innerHTML = `<i class="fas ${icon}"></i>`);
            mobileThemeToggle && (mobileThemeToggle.innerHTML = `<i class="fas ${icon}"></i>`);
        }

        themeToggle?.addEventListener("click", toggleTheme);
        mobileThemeToggle?.addEventListener("click", toggleTheme);

        /* =========================
           MOBILE MENU
        ========================= */
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const closeMenuBtn = document.getElementById("closeMenu");
        const mobileMenu = document.getElementById("mobileMenu");

        mobileMenuBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            mobileMenu.classList.add("active");
            document.body.style.overflow = "hidden";
        });

        closeMenuBtn?.addEventListener("click", () => {
            mobileMenu.classList.remove("active");
            document.body.style.overflow = "auto";
        });

        document.addEventListener("click", (e) => {
            if (
                mobileMenu?.classList.contains("active") &&
                !mobileMenu.contains(e.target) &&
                e.target !== mobileMenuBtn
            ) {
                mobileMenu.classList.remove("active");
                document.body.style.overflow = "auto";
            }
        });

        /* =========================
           CHAT BUBBLE
        ========================= */
        const chatBubble = document.getElementById("chat-bubble");
        const chatbot = document.getElementById("chatbot");

        setTimeout(() => {
            chatBubble?.classList.add("active");
        }, 3000);

        chatbot?.addEventListener("click", () => {
            alert("Technical support would open here.");
        });

        /* =========================
           INIT
        ========================= */
        loadAppointment();
        polling = setInterval(loadAppointment, 5000);

</script>
</body>

</html>