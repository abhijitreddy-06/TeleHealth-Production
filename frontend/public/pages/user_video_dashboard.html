<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Dashboard | TeleHealth</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

<link href="/css/user_video_dashboard.css" rel="stylesheet" />
</head>

<body>
    <!-- ================= HEADER & NAVIGATION ================= -->
    <header>
        <nav class="navbar">
            <a href="/user_home" class="logo">
                <i class="fas fa-heartbeat"></i>
                <span class="logo-text">TeleHealth</span>
            </a>

            <div class="nav-links">
                <a href="/user_home" class="active"><i class="fas fa-home"></i> Home</a>
                <a href="/predict"><i class="fas fa-robot"></i>AI Pre Advice</a>
                <a href="/user_video_dashboard"><i class="fas fa-video"></i>video</a>
                <a href="/appointments"><i class="fas fa-user-md"></i>Appointments</a>
                <a href="/records"><i class="fas fa-folder"></i> My Records</a>
                <a href="/user_profile"><i class="fas fa-user-circle"></i> Profile</a>

                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>

            <div class="mobile-controls">
                <button class="theme-toggle" id="mobileThemeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- ================= MOBILE MENU ================= -->
    <div class="mobile-menu" id="mobileMenu">
        <button class="close-menu" id="closeMenu">
            <i class="fas fa-times"></i>
        </button>
                <a href="/user_home" class="active"><i class="fas fa-home"></i> Home</a>
                <a href="/predict"><i class="fas fa-robot"></i>AI Pre Advice</a>
                <a href="/user_video_dashboard"><i class="fas fa-video"></i>video</a>
                <a href="/appointments"><i class="fas fa-user-md"></i>Appointments</a>
                <a href="/records"><i class="fas fa-folder"></i> My Records</a>
                <a href="/user_profile"><i class="fas fa-user-circle"></i> Profile</a>
    </div>

    <!-- ================= MAIN CONTENT ================= -->
    <main>
        <div class="dashboard-header">
            <h1>Video Consultation Dashboard</h1>
            <p>Join your scheduled virtual appointments with healthcare professionals</p>
        </div>

        <div class="dashboard-grid">
            <!-- Appointment Details Card -->
            <div class="appointment-card">
                <div class="appointment-header">
                    <div class="appointment-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <h2>Your Appointment</h2>
                </div>

                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">Doctor:</span>
                        <span class="info-value" id="doctorName">Loading...</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Date:</span>
                        <span class="info-value" id="apptDate">‚Äî</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">Time:</span>
                        <span class="info-value" id="apptTime">‚Äî</span>
                    </div>
                </div>

                <div class="status-container">
                    <p id="statusText" class="status">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        Checking appointment status...
                    </p>
                </div>

                <button id="joinBtn" class="btn btn-primary btn-full" disabled onclick="joinCall()">
                    <i class="fas fa-video"></i>
                    Join Video Call
                </button>
            </div>

            <!-- Instructions Card -->
            <div class="instructions-card">
                <h3><i class="fas fa-info-circle"></i> Video Call Instructions</h3>
                <div class="instructions-list">
                    <div class="instruction-item">
                        <div class="instruction-number">1</div>
                        <div class="instruction-content">
                            <h4>Prepare Your Environment</h4>
                            <p>Find a quiet, well-lit room with a stable internet connection</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">2</div>
                        <div class="instruction-content">
                            <h4>Test Your Equipment</h4>
                            <p>Check your camera, microphone, and speakers before joining</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">3</div>
                        <div class="instruction-content">
                            <h4>Join on Time</h4>
                            <p>Join the call a few minutes before your scheduled time</p>
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-number">4</div>
                        <div class="instruction-content">
                            <h4>Have Information Ready</h4>
                            <p>Keep your ID and any medical information accessible</p>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </main>

    <!-- ================= FOOTER ================= -->
     <footer class="simple-footer">
        <div class="footer-content">
            <div class="footer-left">
                <a href="/user_home" class="footer-logo">
                    <i class="fas fa-heartbeat"></i>
                    <span>TeleHealth</span>
                </a>
                <div class="copyright">
                    ¬© 2025 TeleHealth. All rights reserved.
                </div>
            </div>

            <div class="footer-links">
                <a href="/privacy">Privacy Policy</a>
                <span class="separator">|</span>
                <a href="/terms">Terms of Service</a>
                <span class="separator">|</span>
                <a href="/contact">Contact</a>
            </div>
        </div>
    </footer>

    <!-- ================= CHATBOT ================= -->
    <div class="chatbot-container">
        <div class="chat-bubble" id="chat-bubble">
            Need help? Chat with our AI assistant!
        </div>
        <div class="chatbot" id="chatbot">
            <i class="fas fa-robot"></i>
        </div>
    </div>

<script src="/js/authGuard.js"></script>
<script>
    /* =========================
       USER VIDEO DASHBOARD
    ========================= */

        let roomId = null;
        let polling = null;

        /* =========================
           LOAD APPOINTMENT (USER)
        ========================= */
        async function loadAppointment() {
            try {
                const res = await fetch("/api/appointments/user", {
                    credentials: "include"
                });

                if (!res.ok) throw new Error("Failed to fetch");

                const appointments = await res.json();

                // ‚ùå No active appointment
                if (!appointments.length) {
                    clearInterval(polling);
                    updateUI({
                        doctor: "‚Äî",
                        date: "‚Äî",
                        time: "‚Äî",
                        statusHTML: `
          <i class="fas fa-calendar-times"></i>
          No active appointments.
        `,
                        statusClass: "status completed",
                        joinDisabled: true
                    });
                    return;
                }

                const appt = appointments[0];

                document.getElementById("doctorName").innerText =
                    `${appt.doctor_name} (${appt.specialization})`;

                document.getElementById("apptDate").innerText = appt.appointment_date;
                document.getElementById("apptTime").innerText = appt.appointment_time;

                // ‚è≥ Scheduled
                if (appt.status === "scheduled") {
                    updateStatus(
                        `<i class="fas fa-clock"></i> Waiting for doctor to start the call...`,
                        "status waiting",
                        true
                    );
                }

                // üé• Started
                if (appt.status === "started" && appt.room_id) {
                    roomId = appt.room_id;
                    updateStatus(
                        `<i class="fas fa-video"></i> Doctor has started the call`,
                        "status ready",
                        false
                    );
                }

                // ‚úÖ Completed
                if (appt.status === "completed") {
                    clearInterval(polling);
                    updateStatus(
                        `<i class="fas fa-check-circle"></i> Appointment completed`,
                        "status completed",
                        true
                    );
                }

            } catch (err) {
                console.error(err);
                updateStatus(
                    `<i class="fas fa-exclamation-triangle"></i> Failed to load appointment`,
                    "status error",
                    true
                );
            }
        }

        /* =========================
           JOIN CALL
        ========================= */
        function joinCall() {
            if (!roomId) return;
            window.location.href = `/user_video/${roomId}`;
        }

        /* =========================
           UI HELPERS
        ========================= */
        function updateStatus(html, className, disableJoin) {
            const statusText = document.getElementById("statusText");
            const joinBtn = document.getElementById("joinBtn");

            statusText.innerHTML = html;
            statusText.className = className;
            joinBtn.disabled = disableJoin;
        }

        function updateUI({ doctor, date, time, statusHTML, statusClass, joinDisabled }) {
            document.getElementById("doctorName").innerText = doctor;
            document.getElementById("apptDate").innerText = date;
            document.getElementById("apptTime").innerText = time;
            updateStatus(statusHTML, statusClass, joinDisabled);
        }

        /* =========================
           THEME TOGGLE (SAFE)
        ========================= */
        const themeToggle = document.getElementById("themeToggle");
        const mobileThemeToggle = document.getElementById("mobileThemeToggle");
        const html = document.documentElement;

        const savedTheme =
            localStorage.getItem("theme") ||
            (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        html.setAttribute("data-theme", savedTheme);
        updateThemeIcon(savedTheme);

        function toggleTheme() {
            const next = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
            html.setAttribute("data-theme", next);
            localStorage.setItem("theme", next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = theme === "dark" ? "fa-sun" : "fa-moon";
            if (themeToggle) themeToggle.innerHTML = `<i class="fas ${icon}"></i>`;
            if (mobileThemeToggle) mobileThemeToggle.innerHTML = `<i class="fas ${icon}"></i>`;
        }

        themeToggle?.addEventListener("click", toggleTheme);
        mobileThemeToggle?.addEventListener("click", toggleTheme);

        /* =========================
           MOBILE MENU (SAFE)
        ========================= */
        const mobileMenuBtn = document.getElementById("mobileMenuBtn");
        const closeMenuBtn = document.getElementById("closeMenu");
        const mobileMenu = document.getElementById("mobileMenu");

        mobileMenuBtn?.addEventListener("click", (e) => {
            e.stopPropagation();
            mobileMenu.classList.add("active");
            document.body.style.overflow = "hidden";
        });

        closeMenuBtn?.addEventListener("click", () => {
            mobileMenu.classList.remove("active");
            document.body.style.overflow = "auto";
        });

        document.addEventListener("click", (e) => {
            if (
                mobileMenu?.classList.contains("active") &&
                !mobileMenu.contains(e.target) &&
                e.target !== mobileMenuBtn
            ) {
                mobileMenu.classList.remove("active");
                document.body.style.overflow = "auto";
            }
        });

        /* =========================
           CHATBOT (OPTIONAL)
        ========================= */
        const chatBubble = document.getElementById("chat-bubble");
        const chatbot = document.getElementById("chatbot");

        setTimeout(() => {
            chatBubble?.classList.add("active");
        }, 3000);

        chatbot?.addEventListener("click", () => {
            alert("Chatbot feature would open here.");
        });

        /* =========================
           INIT
        ========================= */
        loadAppointment();
        polling = setInterval(loadAppointment, 5000);

</script>
</body>

</html>